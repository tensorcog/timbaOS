"use strict";(()=>{var e={};e.id=616,e.ids=[616],e.modules={53524:e=>{e.exports=require("@prisma/client")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},29226:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>v,requestAsyncStorage:()=>h,routeModule:()=>p,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var o={};r.r(o),r.d(o,{POST:()=>m});var n=r(49303),s=r(88716),a=r(60670),i=r(87070);class l{constructor(e,t){this.name=e,this.type=t}log(e){console.log(`[Agent: ${this.name}] ${e}`)}}var c=r(13538);class d extends l{constructor(e){super("StockWatcher","INVENTORY_WATCHER"),this.locationId=e}async run(){this.log(`Checking inventory levels${this.locationId?" for location":" across all locations"}...`);try{let e=await c.Z.locationInventory.findMany({where:{...this.locationId&&{locationId:this.locationId},stockLevel:{lt:c.Z.locationInventory.fields.reorderPoint}},include:{product:{select:{id:!0,name:!0,sku:!0,category:!0}},location:{select:{id:!0,code:!0,name:!0}}},orderBy:{stockLevel:"asc"}});if(0===e.length)return this.log("All stock levels are healthy."),{success:!0,message:"Inventory healthy",data:[]};return this.log(`Found ${e.length} items with low stock.`),{success:!0,message:`Found ${e.length} low stock items`,data:e.map(e=>({location:e.location.name,locationCode:e.location.code,product:e.product.name,sku:e.product.sku,stockLevel:e.stockLevel,reorderPoint:e.reorderPoint,needsRestock:e.reorderPoint-e.stockLevel}))}}catch(e){return console.error("Error running InventoryAgent:",e),{success:!1,message:e.message}}}}class u extends l{constructor(){super("SalesAnalyst","SALES_ANALYST")}async run(){this.log("Starting sales analysis...");try{let e=new Date;e.setDate(e.getDate()-30);let t=await c.Z.order.findMany({where:{createdAt:{gte:e},status:"COMPLETED"},include:{items:!0}});this.log(`Analyzed ${t.length} orders from the last 30 days.`);let r=new Map;for(let e of t){r.has(e.locationId)||r.set(e.locationId,new Map);let t=r.get(e.locationId);for(let r of e.items){let e=t.get(r.productId)||0;t.set(r.productId,e+r.quantity)}}let o=[];for(let[e,t]of Array.from(r.entries()))for(let[r,n]of Array.from(t.entries())){let t=n/30,s=Math.ceil(7*t+3*t),a=Math.ceil(14*t),i=await c.Z.locationInventory.findUnique({where:{locationId_productId:{locationId:e,productId:r}}});i&&Math.abs(i.reorderPoint-s)>5&&(await c.Z.locationInventory.update({where:{id:i.id},data:{reorderPoint:s,reorderQuantity:a}}),o.push({locationId:e,productId:r,oldPoint:i.reorderPoint,newPoint:s}))}return this.log(`Updated inventory settings for ${o.length} items.`),{success:!0,message:`Analyzed sales and updated ${o.length} inventory records.`,data:o}}catch(e){return console.error("Error running SalesAnalystAgent:",e),{success:!1,message:e.message}}}}class g extends l{constructor(){super("ProductRecommender","PRODUCT_RECOMMENDER")}async run(){this.log("Starting product recommendation analysis...");try{let e=(await c.Z.order.findMany({where:{items:{some:{}}},include:{items:!0}})).filter(e=>e.items.length>1);this.log(`Analyzing ${e.length} multi-item orders.`);let t=new Map,r=new Map;for(let o of e){let e=o.items;for(let t of e)r.set(t.productId,(r.get(t.productId)||0)+1);for(let r=0;r<e.length;r++)for(let o=0;o<e.length;o++){if(r===o)continue;let n=e[r].productId,s=e[o].productId;t.has(n)||t.set(n,new Map);let a=t.get(n);a.set(s,(a.get(s)||0)+1)}}let o=0,n=[];for(let[e,s]of(await c.Z.productRecommendation.deleteMany(),Array.from(t.entries()))){let t=r.get(e)||1;for(let[r,a]of Array.from(s.entries())){let s=a/t;if(s>.1){let t=await c.Z.productRecommendation.create({data:{productId:e,recommendedProductId:r,strength:s,reason:`Bought together in ${Math.round(100*s)}% of orders`}});n.push(t),o++}}}return this.log(`Generated ${o} product recommendations.`),{success:!0,message:`Generated ${o} recommendations based on ${e.length} orders.`,data:n}}catch(e){return console.error("Error running ProductRecommendationAgent:",e),{success:!1,message:e.message}}}}async function m(e){try{let t;let{agentType:r,locationId:o}=await e.json();switch(r){case"INVENTORY_WATCHER":t=new d(o);break;case"SALES_ANALYST":t=new u;break;case"PRODUCT_RECOMMENDER":t=new g;break;default:if(r)return i.NextResponse.json({success:!1,message:`Unknown agent type: ${r}`},{status:400});t=new d(o)}let n=await t.run();return i.NextResponse.json(n)}catch(e){return console.error("Error running agent:",e),i.NextResponse.json({success:!1,message:"Failed to run agent"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/agent/run/route",pathname:"/api/agent/run",filename:"route",bundlePath:"app/api/agent/run/route"},resolvedPagePath:"/home/monty/spruce-killer/src/app/api/agent/run/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:y,serverHooks:f}=p,w="/api/agent/run/route";function v(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},13538:(e,t,r)=>{r.d(t,{Z:()=>n});var o=r(53524);let n=globalThis.prisma??new o.PrismaClient}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[276,972],()=>r(29226));module.exports=o})();