generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}



model AuditLog {
  id         String   @id
  entityType String
  entityId   String
  action     String
  changes    Json
  userId     String
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  User       User     @relation(fields: [userId], references: [id])

  @@index([action])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([userId])
  @@index([userId, timestamp])
  @@index([entityType, action, timestamp])
}

model Customer {
  id            String       @id
  name          String
  email         String       @unique
  phone         String?
  address       String?
  accountNumber String?      @unique
  creditLimit   Decimal      @default(0) @db.Decimal(12, 2)
  taxExempt     Boolean      @default(false)
  taxId         String?
  createdAt     DateTime     @default(now())
  updatedAt  DateTime @updatedAt
  loyaltyPoints Int          @default(0)
  customerType  CustomerType @default(RETAIL)
  deletedAt     DateTime?

  // A/R fields
  paymentTermDays      Int      @default(30)
  creditHold           Boolean  @default(false)
  earlyPaymentDiscount Decimal? @db.Decimal(5, 2)

  Order                Order[]
  Quote                Quote[]
  Invoice              Invoice[]
  InvoicePayment       InvoicePayment[]

  @@index([accountNumber])
  @@index([customerType])
  @@index([email])
  @@index([deletedAt])
}

model InventoryTransfer {
  id                                                         String         @id
  transferNumber                                             String         @unique
  originLocationId                                           String
  destinationLocationId                                      String
  notes                                                      String?
  requestedAt                                                DateTime       @default(now())
  approvedAt                                                 DateTime?
  shippedAt                                                  DateTime?
  receivedAt                                                 DateTime?
  approvedById                                               String?
  createdAt                                                  DateTime       @default(now())
  requestedById                                              String
  updatedAt  DateTime @updatedAt
  status                                                     TransferStatus @default(PENDING)
  User_InventoryTransfer_approvedByIdToUser                  User?          @relation("InventoryTransfer_approvedByIdToUser", fields: [approvedById], references: [id])
  Location_InventoryTransfer_destinationLocationIdToLocation Location       @relation("InventoryTransfer_destinationLocationIdToLocation", fields: [destinationLocationId], references: [id])
  Location_InventoryTransfer_originLocationIdToLocation      Location       @relation("InventoryTransfer_originLocationIdToLocation", fields: [originLocationId], references: [id])
  User_InventoryTransfer_requestedByIdToUser                 User           @relation("InventoryTransfer_requestedByIdToUser", fields: [requestedById], references: [id])
  TransferItem                                               TransferItem[]

  @@index([approvedById])
  @@index([destinationLocationId])
  @@index([originLocationId])
  @@index([requestedById])
  @@index([status])
}

model Location {
  id                                                                  String              @id
  code                                                                String              @unique
  name                                                                String
  address                                                             String
  phone                                                               String?
  email                                                               String?
  timezone                                                            String              @default("America/New_York")
  isActive                                                            Boolean             @default(true)
  isWarehouse                                                         Boolean             @default(false)
  managerId                                                           String?
  createdAt                                                           DateTime            @default(now())
  updatedAt  DateTime @updatedAt
  taxRate                                                             Decimal             @default(0.0825) @db.Decimal(5, 4)
  InventoryTransfer_InventoryTransfer_destinationLocationIdToLocation InventoryTransfer[] @relation("InventoryTransfer_destinationLocationIdToLocation")
  InventoryTransfer_InventoryTransfer_originLocationIdToLocation      InventoryTransfer[] @relation("InventoryTransfer_originLocationIdToLocation")
  User                                                                User?               @relation(fields: [managerId], references: [id])
  LocationInventory                                                   LocationInventory[]
  LocationPricing                                                     LocationPricing[]
  Order                                                               Order[]
  Quote                                                               Quote[]
  UserLocation                                                        UserLocation[]
  Invoice                                                             Invoice[]

  @@index([code])
  @@index([isActive])
  @@index([isWarehouse])
  @@index([managerId])
}

model LocationInventory {
  id              String    @id
  locationId      String
  productId       String
  stockLevel      Int       @default(0)
  reorderPoint    Int       @default(10)
  reorderQuantity Int       @default(50)
  maxStock        Int?
  aisle           String?
  bin             String?
  lastCounted     DateTime?
  lastRestocked   DateTime?
  version         Int       @default(0)  // Optimistic locking version
  createdAt       DateTime  @default(now())
  updatedAt  DateTime @updatedAt
  Location        Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  Product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([locationId, productId])
  @@index([locationId])
  @@index([productId])
  @@index([stockLevel])
}

model LocationPricing {
  id            String    @id
  locationId    String
  productId     String
  price         Decimal   @db.Decimal(12, 2)
  cost          Decimal?  @db.Decimal(12, 2)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt  DateTime @updatedAt
  Location      Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  Product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([locationId, productId])
  @@index([effectiveFrom])
  @@index([locationId])
  @@index([productId])
}

model Order {
  id              String          @id
  orderNumber     String          @unique
  locationId      String
  customerId      String
  totalAmount     Decimal         @db.Decimal(12, 2)
  deliveryAddress String?
  deliveryDate    DateTime?
  deliveryFee     Decimal         @default(0) @db.Decimal(12, 2)
  salesRepId      String?
  createdAt       DateTime        @default(now())
  updatedAt  DateTime @updatedAt
  completedAt     DateTime?
  discountAmount  Decimal         @default(0) @db.Decimal(12, 2)
  subtotal        Decimal         @db.Decimal(12, 2)
  taxAmount       Decimal         @default(0) @db.Decimal(12, 2)
  status          OrderStatus     @default(PENDING)
  fulfillmentType FulfillmentType @default(PICKUP)
  orderType       OrderType       @default(STANDARD)
  paymentStatus   PaymentStatus   @default(PENDING)
  deletedAt       DateTime?
  Customer        Customer        @relation(fields: [customerId], references: [id])
  Location        Location        @relation(fields: [locationId], references: [id])
  User            User?           @relation(fields: [salesRepId], references: [id])
  OrderItem       OrderItem[]
  Payment         Payment[]
  Quote           Quote?
  Invoice         Invoice[]

  @@index([createdAt])
  @@index([customerId])
  @@index([locationId])
  @@index([orderNumber])
  @@index([paymentStatus])
  @@index([salesRepId])
  @@index([status])
  @@index([deletedAt])
}

model OrderItem {
  id        String  @id
  orderId   String
  productId String
  quantity  Int
  price     Decimal @db.Decimal(12, 2)
  discount  Decimal @default(0) @db.Decimal(12, 2)
  Order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Product   Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model OrderSequence {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
}

model Payment {
  id            String        @id
  orderId       String
  amount        Decimal       @db.Decimal(12, 2)
  transactionId String?
  processedAt   DateTime      @default(now())
  paymentMethod PaymentMethod
  status        PaymentStatus @default(PAID)
  Order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([processedAt])
  @@index([status])
}

model Product {
  id                                                                        String                  @id
  name                                                                      String
  description                                                               String?
  sku                                                                       String                  @unique
  basePrice                                                                 Decimal                 @db.Decimal(12, 2)
  category                                                                  String
  uom                                                                       String                  @default("EA")
  isActive                                                                  Boolean                 @default(true)
  createdAt                                                                 DateTime                @default(now())
  updatedAt  DateTime @updatedAt
  categoryName                                                              String?
  image                                                                     String?
  tag                                                                       String?
  LocationInventory                                                         LocationInventory[]
  LocationPricing                                                           LocationPricing[]
  OrderItem                                                                 OrderItem[]
  sourceProductRecommendations      ProductRecommendation[] @relation("ProductRecommendation_productIdToProduct")
  recommendedProductRecommendations ProductRecommendation[] @relation("ProductRecommendation_recommendedProductIdToProduct")
  QuoteItem                                                                 QuoteItem[]
  InvoiceItem                                                               InvoiceItem[]
  TransferItem                                                              TransferItem[]

  @@index([category])
  @@index([isActive])
  @@index([sku])
}

model ProductRecommendation {
  id                                                          String   @id
  productId                                                   String
  recommendedProductId                                        String
  strength                                                    Float
  reason                                                      String
  createdAt                                                   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  sourceProduct      Product @relation("ProductRecommendation_productIdToProduct", fields: [productId], references: [id], onDelete: Cascade)
  recommendedProduct Product @relation("ProductRecommendation_recommendedProductIdToProduct", fields: [recommendedProductId], references: [id], onDelete: Cascade)

  @@unique([productId, recommendedProductId])
  @@index([productId])
  @@index([recommendedProductId])
}

model Quote {
  id                 String      @id
  quoteNumber        String      @unique
  locationId         String
  customerId         String
  validUntil         DateTime
  subtotal           Decimal     @db.Decimal(12, 2)
  discountAmount     Decimal     @default(0) @db.Decimal(12, 2)
  taxAmount          Decimal     @db.Decimal(12, 2)
  deliveryFee        Decimal     @default(0) @db.Decimal(12, 2)
  totalAmount        Decimal     @db.Decimal(12, 2)
  notes              String?
  terms              String?
  createdById        String
  convertedToOrderId String?     @unique
  createdAt          DateTime    @default(now())
  updatedAt  DateTime @updatedAt
  sentAt             DateTime?
  acceptedAt         DateTime?
  status             QuoteStatus @default(DRAFT)
  deletedAt          DateTime?
  Order              Order?      @relation(fields: [convertedToOrderId], references: [id])
  User               User        @relation(fields: [createdById], references: [id])
  Customer           Customer    @relation(fields: [customerId], references: [id])
  Location           Location    @relation(fields: [locationId], references: [id])
  QuoteItem          QuoteItem[]
  Invoice            Invoice[]

  @@index([createdById])
  @@index([customerId])
  @@index([locationId])
  @@index([quoteNumber])
  @@index([status])
  @@index([validUntil])
  @@index([deletedAt])
}

model QuoteItem {
  id        String  @id
  quoteId   String
  productId String
  quantity  Int
  unitPrice Decimal @db.Decimal(12, 2)
  discount  Decimal @default(0) @db.Decimal(12, 2)
  subtotal  Decimal @db.Decimal(12, 2)
  Product   Product @relation(fields: [productId], references: [id])
  Quote     Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([quoteId])
}

model QuoteSequence {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model SystemConfig {
  key         String   @id
  value       Json
  description String?
  updatedAt  DateTime @updatedAt
}

model TransferItem {
  id                String            @id
  transferId        String
  productId         String
  requestedQty      Int
  shippedQty        Int?
  receivedQty       Int?
  Product           Product           @relation(fields: [productId], references: [id])
  InventoryTransfer InventoryTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([transferId])
}

model User {
  id                                                      String              @id
  email                                                   String              @unique
  name                                                    String
  password                                                String
  profilePicture                                          String?
  isActive                                                Boolean             @default(true)
  tokenVersion                                            Int                 @default(0)  // Increment to invalidate JWTs
  createdAt                                               DateTime            @default(now())
  updatedAt  DateTime @updatedAt
  role                                                    UserRole
  Account                                                 Account[]
  AuditLog                                                AuditLog[]
  transfersApproved  InventoryTransfer[] @relation("InventoryTransfer_approvedByIdToUser")
  transfersRequested InventoryTransfer[] @relation("InventoryTransfer_requestedByIdToUser")
  Location                                                Location[]
  Order                                                   Order[]
  Quote                                                   Quote[]
  Session                                                 Session[]
  UserLocation                                            UserLocation[]
  UserPreferences                                         UserPreferences?
  PasswordResetToken                                      PasswordResetToken[]
  InvoicesCreated                                         Invoice[]              @relation("InvoiceCreatedBy")
  InvoicePaymentsRecorded                                 InvoicePayment[]       @relation("PaymentRecordedBy")

  @@index([email])
  @@index([isActive])
  @@index([role])
}

model UserLocation {
  id         String   @id
  userId     String
  locationId String
  canManage  Boolean  @default(false)
  createdAt  DateTime @default(now())
  Location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([locationId])
  @@index([userId])
}

model UserPreferences {
  id                   String   @id
  userId               String   @unique
  theme                Theme    @default(DEFAULT)
  customTheme          Json?
  emailNotifications   Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt  DateTime @updatedAt
  User                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Theme {
  DEFAULT
  OCEAN
  FOREST
  SUNSET
}

enum CustomerType {
  RETAIL
  WHOLESALE
  CONTRACTOR
  BUILDER
}

enum FulfillmentType {
  PICKUP
  DELIVERY
  WILL_CALL
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum OrderType {
  STANDARD
  POS
  QUOTE_CONVERSION
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  CHECK
  ACCOUNT
  WIRE_TRANSFER
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  FAILED
}

enum QuoteStatus {
  DRAFT
  PENDING
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum TransferStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  RECEIVED
  CANCELLED
}

enum UserRole {
  SUPER_ADMIN
  LOCATION_ADMIN
  MANAGER
  SALES
  WAREHOUSE
}

model PasswordResetToken {
  id        String   @id
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  used      Boolean  @default(false)
  
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// Invoicing Models

model Invoice {
  id              String         @id
  invoiceNumber   String         @unique
  customerId      String
  locationId      String
  orderId         String?
  quoteId         String?

  invoiceDate     DateTime       @default(now())
  dueDate         DateTime
  status          InvoiceStatus  @default(DRAFT)

  subtotal        Decimal        @db.Decimal(12, 2)
  taxAmount       Decimal        @db.Decimal(12, 2)
  discountAmount  Decimal        @db.Decimal(12, 2) @default(0)
  deliveryFee     Decimal        @db.Decimal(12, 2) @default(0)
  totalAmount     Decimal        @db.Decimal(12, 2)

  paidAmount      Decimal        @db.Decimal(12, 2) @default(0)
  balanceDue      Decimal        @db.Decimal(12, 2)

  lateFeeAmount   Decimal?       @db.Decimal(12, 2)
  lateFeeApplied  Boolean        @default(false)

  notes           String?
  terms           String?
  paymentTermDays Int            @default(30)
  sentAt          DateTime?
  paidAt          DateTime?
  deletedAt       DateTime?

  createdById     String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  Customer        Customer       @relation(fields: [customerId], references: [id])
  Location        Location       @relation(fields: [locationId], references: [id])
  Order           Order?         @relation(fields: [orderId], references: [id])
  Quote           Quote?         @relation(fields: [quoteId], references: [id])
  CreatedBy       User           @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  InvoiceItem     InvoiceItem[]
  InvoicePayment  InvoicePayment[]

  @@index([customerId])
  @@index([locationId])
  @@index([status])
  @@index([dueDate])
  @@index([invoiceDate])
  @@index([invoiceNumber])
  @@index([deletedAt])
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIALLY_PAID
  PAID
  OVERDUE
  CANCELLED
  WRITTEN_OFF
}

model InvoiceItem {
  id          String  @id
  invoiceId   String
  productId   String
  
  description String
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discount    Decimal @db.Decimal(12, 2) @default(0)
  subtotal    Decimal @db.Decimal(12, 2)
  
  Invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  Product     Product @relation(fields: [productId], references: [id])
  
  @@index([invoiceId])
  @@index([productId])
}

model InvoicePayment {
  id              String               @id
  invoiceId       String?
  customerId      String
  
  paymentDate     DateTime             @default(now())
  amount          Decimal              @db.Decimal(12, 2)
  appliedAmount   Decimal              @db.Decimal(12, 2) @default(0)
  unappliedAmount Decimal              @db.Decimal(12, 2)
  
  paymentMethod   InvoicePaymentMethod
  referenceNumber String?
  notes           String?
  
  recordedById    String
  recordedAt      DateTime             @default(now())
  
  Invoice         Invoice?             @relation(fields: [invoiceId], references: [id])
  Customer        Customer             @relation(fields: [customerId], references: [id])
  RecordedBy      User                 @relation("PaymentRecordedBy", fields: [recordedById], references: [id])
  
  @@index([customerId])
  @@index([invoiceId])
  @@index([paymentDate])
}

enum InvoicePaymentMethod {
  CASH
  CHECK
  CREDIT_CARD
  DEBIT_CARD
  ACH
  WIRE_TRANSFER
  OTHER
}

model InvoiceSequence {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
}

model CompanySettings {
  id          String   @id
  companyName String
  logo        String?
  address     String?
  phone       String?
  email       String?
  taxId       String?
  website     String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

