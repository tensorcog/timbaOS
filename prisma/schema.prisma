generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Agent {
  id         String    @id
  name       String
  type       String
  status     String
  scope      String    @default("LOCATION")
  locationId String?
  config     Json?
  lastRun    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime
  Location   Location? @relation(fields: [locationId], references: [id])

  @@index([locationId])
  @@index([status])
  @@index([type])
}

model AuditLog {
  id         String   @id
  entityType String
  entityId   String
  action     String
  changes    Json
  userId     String
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  User       User     @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([userId])
}

model Customer {
  id            String   @id
  name          String
  email         String   @unique
  phone         String?
  address       String?
  customerType  String   @default("RETAIL")
  accountNumber String?  @unique
  creditLimit   Decimal  @default(0)
  taxExempt     Boolean  @default(false)
  taxId         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  loyaltyPoints Int      @default(0)
  Order         Order[]
  Quote         Quote[]
}

model InventoryTransfer {
  id                                                         String         @id
  transferNumber                                             String         @unique
  originLocationId                                           String
  destinationLocationId                                      String
  status                                                     String         @default("PENDING")
  requestedBy                                                String
  approvedBy                                                 String?
  notes                                                      String?
  requestedAt                                                DateTime       @default(now())
  approvedAt                                                 DateTime?
  shippedAt                                                  DateTime?
  receivedAt                                                 DateTime?
  User_InventoryTransfer_approvedByToUser                    User?          @relation("InventoryTransfer_approvedByToUser", fields: [approvedBy], references: [id])
  Location_InventoryTransfer_destinationLocationIdToLocation Location       @relation("InventoryTransfer_destinationLocationIdToLocation", fields: [destinationLocationId], references: [id])
  Location_InventoryTransfer_originLocationIdToLocation      Location       @relation("InventoryTransfer_originLocationIdToLocation", fields: [originLocationId], references: [id])
  User_InventoryTransfer_requestedByToUser                   User           @relation("InventoryTransfer_requestedByToUser", fields: [requestedBy], references: [id])
  TransferItem                                               TransferItem[]

  @@index([destinationLocationId])
  @@index([originLocationId])
  @@index([status])
}

model Location {
  id                                                                  String              @id
  code                                                                String              @unique
  name                                                                String
  address                                                             String
  phone                                                               String?
  email                                                               String?
  timezone                                                            String              @default("America/New_York")
  isActive                                                            Boolean             @default(true)
  isWarehouse                                                         Boolean             @default(false)
  managerId                                                           String?
  createdAt                                                           DateTime            @default(now())
  updatedAt                                                           DateTime
  taxRate                                                             Decimal             @default(0.0825)
  Agent                                                               Agent[]
  InventoryTransfer_InventoryTransfer_destinationLocationIdToLocation InventoryTransfer[] @relation("InventoryTransfer_destinationLocationIdToLocation")
  InventoryTransfer_InventoryTransfer_originLocationIdToLocation      InventoryTransfer[] @relation("InventoryTransfer_originLocationIdToLocation")
  User                                                                User?               @relation(fields: [managerId], references: [id])
  LocationInventory                                                   LocationInventory[]
  LocationPricing                                                     LocationPricing[]
  Order                                                               Order[]
  Quote                                                               Quote[]
  UserLocation                                                        UserLocation[]
}

model LocationInventory {
  id              String    @id
  locationId      String
  productId       String
  stockLevel      Int       @default(0)
  reorderPoint    Int       @default(10)
  reorderQuantity Int       @default(50)
  maxStock        Int?
  aisle           String?
  bin             String?
  lastCounted     DateTime?
  lastRestocked   DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  Location        Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  Product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([locationId, productId])
  @@index([locationId])
  @@index([productId])
  @@index([stockLevel])
}

model LocationPricing {
  id            String    @id
  locationId    String
  productId     String
  price         Decimal
  cost          Decimal?
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  Location      Location  @relation(fields: [locationId], references: [id], onDelete: Cascade)
  Product       Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([locationId, productId])
  @@index([locationId])
  @@index([productId])
}

model Order {
  id              String      @id
  orderNumber     String      @unique
  locationId      String
  customerId      String
  status          String      @default("PENDING")
  totalAmount     Decimal
  fulfillmentType String      @default("PICKUP")
  deliveryAddress String?
  deliveryDate    DateTime?
  deliveryFee     Decimal     @default(0)
  salesRepId      String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime
  completedAt     DateTime?
  discountAmount  Decimal     @default(0)
  orderType       String      @default("STANDARD")
  paymentStatus   String      @default("PENDING")
  subtotal        Decimal
  taxAmount       Decimal     @default(0)
  Customer        Customer    @relation(fields: [customerId], references: [id])
  Location        Location    @relation(fields: [locationId], references: [id])
  User            User?       @relation(fields: [salesRepId], references: [id])
  OrderItem       OrderItem[]
  Payment         Payment[]
  Quote           Quote?

  @@index([createdAt])
  @@index([customerId])
  @@index([locationId])
  @@index([status])
}

model OrderItem {
  id        String  @id
  orderId   String
  productId String
  quantity  Int
  price     Decimal
  discount  Decimal @default(0)
  Order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  Product   Product @relation(fields: [productId], references: [id])
}

model Payment {
  id            String   @id
  orderId       String
  paymentMethod String
  amount        Decimal
  transactionId String?
  status        String   @default("COMPLETED")
  processedAt   DateTime @default(now())
  Order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Product {
  id                                                                        String                  @id
  name                                                                      String
  description                                                               String?
  sku                                                                       String                  @unique
  basePrice                                                                 Decimal
  category                                                                  String
  uom                                                                       String                  @default("EA")
  isActive                                                                  Boolean                 @default(true)
  createdAt                                                                 DateTime                @default(now())
  updatedAt                                                                 DateTime
  LocationInventory                                                         LocationInventory[]
  LocationPricing                                                           LocationPricing[]
  OrderItem                                                                 OrderItem[]
  ProductRecommendation_ProductRecommendation_productIdToProduct            ProductRecommendation[] @relation("ProductRecommendation_productIdToProduct")
  ProductRecommendation_ProductRecommendation_recommendedProductIdToProduct ProductRecommendation[] @relation("ProductRecommendation_recommendedProductIdToProduct")
  QuoteItem                                                                 QuoteItem[]
  TransferItem                                                              TransferItem[]
}

model ProductRecommendation {
  id                                                          String   @id
  productId                                                   String
  recommendedProductId                                        String
  strength                                                    Float
  reason                                                      String
  createdAt                                                   DateTime @default(now())
  updatedAt                                                   DateTime
  Product_ProductRecommendation_productIdToProduct            Product  @relation("ProductRecommendation_productIdToProduct", fields: [productId], references: [id], onDelete: Cascade)
  Product_ProductRecommendation_recommendedProductIdToProduct Product  @relation("ProductRecommendation_recommendedProductIdToProduct", fields: [recommendedProductId], references: [id], onDelete: Cascade)

  @@unique([productId, recommendedProductId])
  @@index([productId])
}

model Quote {
  id                 String      @id
  quoteNumber        String      @unique
  locationId         String
  customerId         String
  status             String      @default("PENDING")
  validUntil         DateTime
  subtotal           Decimal
  discountAmount     Decimal     @default(0)
  taxAmount          Decimal
  deliveryFee        Decimal     @default(0)
  totalAmount        Decimal
  notes              String?
  terms              String?
  createdById        String
  convertedToOrderId String?     @unique
  createdAt          DateTime    @default(now())
  updatedAt          DateTime
  sentAt             DateTime?
  acceptedAt         DateTime?
  Order              Order?      @relation(fields: [convertedToOrderId], references: [id])
  User               User        @relation(fields: [createdById], references: [id])
  Customer           Customer    @relation(fields: [customerId], references: [id])
  Location           Location    @relation(fields: [locationId], references: [id])
  QuoteItem          QuoteItem[]

  @@index([customerId])
  @@index([locationId])
  @@index([status])
}

model QuoteItem {
  id        String  @id
  quoteId   String
  productId String
  quantity  Int
  unitPrice Decimal
  discount  Decimal @default(0)
  subtotal  Decimal
  Product   Product @relation(fields: [productId], references: [id])
  Quote     Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@index([quoteId])
}

model QuoteSequence {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SystemConfig {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime
}

model TransferItem {
  id                String            @id
  transferId        String
  productId         String
  requestedQty      Int
  shippedQty        Int?
  receivedQty       Int?
  Product           Product           @relation(fields: [productId], references: [id])
  InventoryTransfer InventoryTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)

  @@index([transferId])
}

model User {
  id                                                    String              @id
  email                                                 String              @unique
  name                                                  String
  password                                              String
  role                                                  String
  isActive                                              Boolean             @default(true)
  createdAt                                             DateTime            @default(now())
  updatedAt                                             DateTime
  Account                                               Account[]
  AuditLog                                              AuditLog[]
  InventoryTransfer_InventoryTransfer_approvedByToUser  InventoryTransfer[] @relation("InventoryTransfer_approvedByToUser")
  InventoryTransfer_InventoryTransfer_requestedByToUser InventoryTransfer[] @relation("InventoryTransfer_requestedByToUser")
  Location                                              Location[]
  Order                                                 Order[]
  Quote                                                 Quote[]
  Session                                               Session[]
  UserLocation                                          UserLocation[]
}

model UserLocation {
  id         String   @id
  userId     String
  locationId String
  canManage  Boolean  @default(false)
  createdAt  DateTime @default(now())
  Location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([locationId])
  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
